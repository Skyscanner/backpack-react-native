name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

defaults:
  run:
    shell: bash -l {0}

jobs:

  Build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup NPM
        run: |
          nvm install
          npm ci

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Gradle Lint
        run: ./android/gradlew -p android ktlint

      - name: Gradle build
        run: ./android/gradlew -p android :app:assembleDebug :backpack-react-native:assembleAndroidTest
      
      # Only run tests if not in a forked repo as it depends on secrets not available to forks
      - name: Run Android tests
        if: github.event.pull_request.head.repo.full_name == github.repository
        run: ./scripts/android/ci-tests.sh
      
# For now we will run the old tests compared to #715 as they use features that are available in the RN 64 upgrade. Once the PR is merged these can be reinstated and replaced.
      # - name: Run Android unit tests
        # run: ./android/gradlew -p android :app:Test :backpack-react-native:Test
  
  # These tests currently fail so we will need a follow up ticket to fix them.
  # Android:
  #   name: Android Connected
  #   runs-on: macos-latest

  #   steps:
  #     - uses: actions/checkout@v2

  #     - name: Setup NPM
  #       run: |
  #         nvm install
  #         npm ci

  #     - name: Run Android connected tests
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         target: google_apis
  #         profile: Nexus 4
  #         sdcard-path-or-size: 512M
  #         api-level: 21
  #         script: ./android/gradlew -p android :backpack-react-native:connectedAndroidTest
